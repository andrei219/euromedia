<html>
<head>
<title>advanced_sale_proforma_form.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
advanced_sale_proforma_form.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">datetime </span><span class="s0">import </span><span class="s1">date</span>

<span class="s0">from </span><span class="s1">PyQt5.QtWidgets </span><span class="s0">import </span><span class="s1">QWidget</span><span class="s0">, </span><span class="s1">QMessageBox</span>

<span class="s0">import </span><span class="s1">db</span>
<span class="s0">from </span><span class="s1">db </span><span class="s0">import </span><span class="s1">Agent</span><span class="s0">, </span><span class="s1">Partner</span>
<span class="s0">from </span><span class="s1">models </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">AdvancedLinesModel</span><span class="s0">,</span>
    <span class="s1">IncomingStockModel</span><span class="s0">,</span>
    <span class="s1">computeCreditAvailable</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">sale_proforma_form </span><span class="s0">import </span><span class="s1">Form</span>
<span class="s0">from </span><span class="s1">ui_advanced_sale_proforma_form </span><span class="s0">import </span><span class="s1">Ui_Form</span>
<span class="s0">from </span><span class="s1">utils </span><span class="s0">import </span><span class="s1">setCommonViewConfig</span>

<span class="s0">import </span><span class="s1">utils</span>


<span class="s0">def </span><span class="s1">reload_utils():</span>
    <span class="s0">global </span><span class="s1">utils</span>
    <span class="s0">from </span><span class="s1">importlib </span><span class="s0">import </span><span class="s1">reload</span>
    <span class="s1">utils = reload(utils)</span>


<span class="s0">class </span><span class="s1">Form(Ui_Form</span><span class="s0">, </span><span class="s1">QWidget):</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">parent</span><span class="s0">, </span><span class="s1">view):</span>
        <span class="s1">self.proforma = </span><span class="s0">None</span>
        <span class="s1">reload_utils()</span>
        <span class="s1">super().__init__()</span>
        <span class="s1">self.setupUi(self)</span>
        <span class="s1">setCommonViewConfig(self.stock_view)</span>
        <span class="s1">self.model = view.model()</span>
        <span class="s1">self.init_template()</span>
        <span class="s1">self.parent = parent</span>
        <span class="s1">self.lines_model = AdvancedLinesModel(self.proforma)</span>
        <span class="s1">self.lines_view.setModel(self.lines_model)</span>
        <span class="s1">self.set_combos()</span>
        <span class="s1">self.set_completers()</span>
        <span class="s1">self.set_handlers()</span>

    <span class="s0">def </span><span class="s1">init_template(self):</span>
        <span class="s1">self.proforma = db.SaleProforma()</span>
        <span class="s1">db.session.add(self.proforma)</span>
        <span class="s1">db.session.flush()</span>
        <span class="s1">self.date.setText(date.today().strftime(</span><span class="s2">'%d%m%Y'</span><span class="s1">))</span>
        <span class="s1">self.type.setCurrentText(</span><span class="s2">'1'</span><span class="s1">)</span>
        <span class="s1">self.number.setText(str(self.model.nextNumberOfType(</span><span class="s3">1</span><span class="s1">)).zfill(</span><span class="s3">6</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">set_handlers(self):</span>
        <span class="s1">self.partner.returnPressed.connect(self.partner_search)</span>
        <span class="s1">self.delete_.clicked.connect(self.delete_handler)</span>
        <span class="s1">self.add.clicked.connect(self.add_handler)</span>
        <span class="s1">self.save.clicked.connect(self.save_handler)</span>
        <span class="s1">self.insert.clicked.connect(self.insert_handler)</span>
        <span class="s1">self.type.currentTextChanged.connect(self.type_changed)</span>
        <span class="s1">self.search.clicked.connect(self.search_handler)</span>
        <span class="s1">self.warehouse.currentTextChanged.connect(self.warehouse_handler)</span>

    <span class="s0">def </span><span class="s1">set_combos(self):</span>
        <span class="s0">for </span><span class="s1">combo</span><span class="s0">, </span><span class="s1">data </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(self.agent</span><span class="s0">, </span><span class="s1">utils.agent_id_map.keys())</span><span class="s0">,</span>
            <span class="s1">(self.warehouse</span><span class="s0">, </span><span class="s1">utils.warehouse_id_map.keys())</span><span class="s0">,</span>
            <span class="s1">(self.courier</span><span class="s0">, </span><span class="s1">utils.courier_id_map.keys())</span>
        <span class="s1">]: combo.addItems(data)</span>

    <span class="s0">def </span><span class="s1">set_completers(self):</span>
        <span class="s0">for </span><span class="s1">field</span><span class="s0">, </span><span class="s1">data </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(self.partner</span><span class="s0">, </span><span class="s1">utils.partner_id_map.keys())</span><span class="s0">,</span>
            <span class="s1">(self.description</span><span class="s0">, </span><span class="s1">utils.descriptions)</span><span class="s0">,</span>
            <span class="s1">(self.spec</span><span class="s0">, </span><span class="s1">utils.specs)</span><span class="s0">,</span>
            <span class="s1">(self.condition</span><span class="s0">, </span><span class="s1">utils.conditions)</span>
        <span class="s1">]: utils.setCompleter(field</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s0">def </span><span class="s1">proforma_to_form(self):</span>
        <span class="s1">p = self.proforma</span>

        <span class="s1">self.type.setCurrentText(str(p.type))</span>
        <span class="s1">self.number.setText(str(p.number))</span>
        <span class="s1">self.date.setText(p.date.strftime(</span><span class="s2">'%d%m%Y'</span><span class="s1">))</span>
        <span class="s1">self.partner.setText(p.partner.fiscal_name)</span>
        <span class="s1">self.agent.setCurrentText(p.agent.fiscal_name)</span>
        <span class="s1">self.warehouse.setCurrentText(p.warehouse.description)</span>
        <span class="s1">self.courier.setCurrentText(p.courier.description)</span>
        <span class="s1">self.incoterms.setCurrentText(p.incoterm)</span>
        <span class="s1">self.warranty.setValue(p.warranty)</span>
        <span class="s1">self.days.setValue(p.credit_days)</span>
        <span class="s1">self.eur.setChecked(p.eur_currency)</span>
        <span class="s1">self.credit.setValue(p.credit_amount)</span>
        <span class="s1">self.external.setText(p.external)</span>
        <span class="s1">self.tracking.setText(p.tracking)</span>
        <span class="s1">self.they_pay_we_ship.setChecked(p.they_pay_we_ship)</span>
        <span class="s1">self.they_pay_they_ship.setChecked(p.they_pay_they_ship)</span>
        <span class="s1">self.we_pay_we_ship.setChecked(p.we_pay_we_ship)</span>

    <span class="s0">def </span><span class="s1">set_stock_mv(self):</span>
        <span class="s1">warehouse_id = utils.warehouse_id_map.get(</span>
            <span class="s1">self.warehouse.currentText()</span>
        <span class="s1">)</span>

        <span class="s1">description = self.description.text()</span>
        <span class="s1">condition = self.condition.text()</span>
        <span class="s1">spec = self.spec.text()</span>

        <span class="s0">if </span><span class="s1">spec == </span><span class="s2">'Mix' </span><span class="s0">or not </span><span class="s1">spec:</span>
            <span class="s1">spec = </span><span class="s0">None</span>
        <span class="s0">if </span><span class="s1">condition == </span><span class="s2">'Mix' </span><span class="s0">or not </span><span class="s1">condition:</span>
            <span class="s1">condition = </span><span class="s0">None</span>

        <span class="s1">self.stock_model = IncomingStockModel(</span>
            <span class="s1">warehouse_id</span><span class="s0">,</span>
            <span class="s1">description=description</span><span class="s0">,</span>
            <span class="s1">condition=condition</span><span class="s0">,</span>
            <span class="s1">spec=spec</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">self.stock_view.setModel(self.stock_model)</span>

    <span class="s0">def </span><span class="s1">search_handler(self):</span>
        <span class="s1">self.set_stock_mv()</span>

    <span class="s0">def </span><span class="s1">warehouse_handler(self):</span>
        <span class="s0">if </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s2">'stock_model'</span><span class="s1">):</span>
            <span class="s1">self.stock_model.reset()</span>

        <span class="s0">if </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s2">'lines_model'</span><span class="s1">):</span>
            <span class="s1">self.lines_model.reset()</span>

        <span class="s1">self.update_totals()</span>
        <span class="s4"># removing objects in pending state </span>
        <span class="s1">db.session.rollback()</span>

    <span class="s0">def </span><span class="s1">update_totals(self):</span>

        <span class="s1">self.subtotal.setText(str(self.lines_model.subtotal))</span>
        <span class="s1">self.sale_tax.setText(str(self.lines_model.tax))</span>
        <span class="s1">self.total.setText(str(self.lines_model.total))</span>

    <span class="s0">def </span><span class="s1">delete_handler(self):</span>
        <span class="s1">indexes = self.lines_view.selectedIndexes()</span>
        <span class="s0">if not </span><span class="s1">indexes: </span><span class="s0">return</span>
        <span class="s1">row = {index.row() </span><span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">indexes}.pop()</span>
        <span class="s1">self.lines_model.delete(row)</span>
        <span class="s1">self.lines_view.clearSelection()</span>

        <span class="s1">self.set_stock_mv()</span>
        <span class="s1">self.update_totals()</span>

    <span class="s0">def </span><span class="s1">add_handler(self):</span>
        <span class="s0">if not </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s2">'stock_model'</span><span class="s1">): </span><span class="s0">return</span>
        <span class="s1">indexes = self.stock_view.selectedIndexes()</span>
        <span class="s0">if not </span><span class="s1">indexes: </span><span class="s0">return</span>
        <span class="s1">row = {i.row() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">indexes}.pop()</span>
        <span class="s1">vector = self.stock_model[row]</span>

        <span class="s1">quantity = self.quantity.value()</span>
        <span class="s0">if </span><span class="s1">quantity &gt; vector.available:</span>
            <span class="s1">QMessageBox.critical(</span>
                <span class="s1">self</span><span class="s0">,</span>
                <span class="s2">'Error'</span><span class="s0">,</span>
                <span class="s2">'quantity must be less than available'</span>
            <span class="s1">)</span>
            <span class="s0">return</span>

        <span class="s1">price = self.price.value()</span>
        <span class="s1">ignore = self.ignore.isChecked()</span>
        <span class="s1">tax = int(self.tax.currentText())</span>
        <span class="s1">showing = self.showing_condition.text()</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">self.lines_model.add(quantity</span><span class="s0">, </span><span class="s1">price</span><span class="s0">, </span><span class="s1">ignore</span><span class="s0">, </span><span class="s1">tax</span><span class="s0">, </span><span class="s1">showing</span><span class="s0">, </span><span class="s1">vector)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">ex:</span>
            <span class="s0">raise</span>
            <span class="s1">QMessageBox.critical(self</span><span class="s0">, </span><span class="s2">'Error'</span><span class="s0">, </span><span class="s1">str(ex))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">self.update_totals()</span>
            <span class="s1">self.set_stock_mv()</span>

    <span class="s0">def </span><span class="s1">partner_search(self):</span>
        <span class="s1">partner_id = utils.partner_id_map.get(self.partner.text())</span>
        <span class="s0">if not </span><span class="s1">partner_id:</span>
            <span class="s0">return</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">available_credit = computeCreditAvailable(partner_id)</span>
            <span class="s1">self.available_credit.setValue(float(available_credit))</span>
            <span class="s1">self.credit.setMaximum(float(available_credit))</span>

        <span class="s0">except </span><span class="s1">TypeError:</span>
            <span class="s0">raise</span>

        <span class="s1">result = db.session.query(Agent.fiscal_name</span><span class="s0">, </span><span class="s1">Partner.warranty</span><span class="s0">, </span><span class="s1">Partner.euro</span><span class="s0">,</span>
                                  <span class="s1">Partner.they_pay_they_ship</span><span class="s0">, </span><span class="s1">Partner.they_pay_we_ship</span><span class="s0">, </span><span class="s1">Partner.we_pay_we_ship</span><span class="s0">,</span>
                                  <span class="s1">Partner.days_credit_limit).join(Agent).where(Partner.id == partner_id).one()</span>

        <span class="s1">agent</span><span class="s0">, </span><span class="s1">warranty</span><span class="s0">, </span><span class="s1">euro</span><span class="s0">, </span><span class="s1">they_pay_they_ship</span><span class="s0">, </span><span class="s1">they_pay_we_ship</span><span class="s0">, </span><span class="s1">we_pay_we_ship</span><span class="s0">, </span><span class="s1">days = \</span>
            <span class="s1">result</span>

        <span class="s1">self.agent.setCurrentText(agent)</span>
        <span class="s1">self.warranty.setValue(warranty)</span>
        <span class="s1">self.eur.setChecked(euro)</span>
        <span class="s1">self.they_pay_they_ship.setChecked(they_pay_they_ship)</span>
        <span class="s1">self.they_pay_we_ship.setChecked(they_pay_we_ship)</span>
        <span class="s1">self.we_pay_we_ship.setChecked(we_pay_we_ship)</span>

    <span class="s0">def </span><span class="s1">insert_handler(self):</span>
        <span class="s0">from </span><span class="s1">free_line_form </span><span class="s0">import </span><span class="s1">Dialog</span>
        <span class="s1">dialog = Dialog(self)</span>
        <span class="s0">if </span><span class="s1">dialog.exec_():</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">description = dialog.description.text()</span>
                <span class="s0">if not </span><span class="s1">description:</span>
                    <span class="s0">return</span>

                <span class="s1">self.lines_model.insert_free(</span>
                    <span class="s1">description</span><span class="s0">,</span>
                    <span class="s1">dialog.quantity.value()</span><span class="s0">,</span>
                    <span class="s1">dialog.price.value()</span><span class="s0">,</span>
                    <span class="s1">int(dialog.tax.currentText())</span>
                <span class="s1">)</span>
            <span class="s0">except</span><span class="s1">:</span>
                <span class="s0">raise</span>
                <span class="s1">QMessageBox.critical(</span>
                    <span class="s1">self</span><span class="s0">,</span>
                    <span class="s2">'Error'</span><span class="s0">,</span>
                    <span class="s2">'Error adding free line'</span>
                <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">type_changed(self</span><span class="s0">, </span><span class="s1">type):</span>
        <span class="s1">next_num = self.model.nextNumberOfType(int(type))</span>
        <span class="s1">self.number.setText(str(next_num).zfill(</span><span class="s3">6</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">save_handler(self):</span>
        <span class="s0">if not </span><span class="s1">self._valid_header(): </span><span class="s0">return</span>
        <span class="s0">if not </span><span class="s1">self.lines_model:</span>
            <span class="s1">QMessageBox.critical(self</span><span class="s0">, </span><span class="s2">'Error'</span><span class="s0">, </span><span class="s2">&quot;Can't process empty proforma&quot;</span><span class="s1">)</span>
            <span class="s0">return</span>

        <span class="s1">warehouse_id = utils.warehouse_id_map.get(self.warehouse.currentText())</span>
        <span class="s1">lines = self.lines_model.lines</span>

        <span class="s0">if </span><span class="s1">hasattr(self</span><span class="s0">, </span><span class="s2">'stock_model'</span><span class="s1">):</span>
            <span class="s0">if </span><span class="s1">self.stock_model.lines_against_stock(warehouse_id</span><span class="s0">, </span><span class="s1">lines):</span>
                <span class="s1">QMessageBox.critical(</span>
                    <span class="s1">self</span><span class="s0">,</span>
                    <span class="s2">'Error'</span><span class="s0">,</span>
                    <span class="s2">'Someone took those incoming stocks. Start again.'</span>
                <span class="s1">)</span>
                <span class="s1">self.close()</span>
                <span class="s0">return</span>

        <span class="s1">self._form_to_proforma()</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">self.save_template()</span>
            <span class="s1">db.session.commit()</span>

        <span class="s0">except</span><span class="s1">:</span>
            <span class="s0">raise</span>
            <span class="s1">db.session.rollback()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">QMessageBox.information(self</span><span class="s0">, </span><span class="s2">'Success'</span><span class="s0">, </span><span class="s2">'Sale saved successfully'</span><span class="s1">)</span>

        <span class="s1">self.close()</span>

    <span class="s0">def </span><span class="s1">save_template(self):</span>
        <span class="s1">self.model.add(self.proforma)</span>
        <span class="s1">self.proforma.advanced_lines.extend(self.lines_model.lines)</span>

    <span class="s0">def </span><span class="s1">_valid_header(self):</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">utils.partner_id_map[self.partner.text()]</span>
        <span class="s0">except </span><span class="s1">KeyError:</span>
            <span class="s1">QMessageBox.critical(self</span><span class="s0">, </span><span class="s2">'Update - Error'</span><span class="s0">, </span><span class="s2">'Invalid Partner'</span><span class="s1">)</span>
            <span class="s0">return False</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">utils.parse_date(self.date.text())</span>
        <span class="s0">except </span><span class="s1">ValueError:</span>
            <span class="s1">QMessageBox.critical(self</span><span class="s0">, </span><span class="s2">'Update - Error'</span><span class="s0">, </span><span class="s2">'Error in date field. Format: ddmmyyyy'</span><span class="s1">)</span>
            <span class="s0">return False</span>
        <span class="s0">return True</span>

    <span class="s0">def </span><span class="s1">closeEvent(self</span><span class="s0">, </span><span class="s1">event):</span>
        <span class="s1">db.session.rollback()</span>

    <span class="s0">def </span><span class="s1">_form_to_proforma(self):</span>

        <span class="s1">self.proforma.type = int(self.type.currentText())</span>
        <span class="s1">self.proforma.number = int(self.number.text())</span>
        <span class="s1">self.proforma.date = utils.parse_date(self.date.text())</span>
        <span class="s1">self.proforma.warranty = self.warranty.value()</span>
        <span class="s1">self.proforma.they_pay_they_ship = self.they_pay_they_ship.isChecked()</span>
        <span class="s1">self.proforma.they_pay_we_ship = self.they_pay_we_ship.isChecked()</span>
        <span class="s1">self.proforma.we_pay_we_ship = self.we_pay_we_ship.isChecked()</span>
        <span class="s1">self.proforma.agent_id = utils.agent_id_map[self.agent.currentText()]</span>
        <span class="s1">self.proforma.partner_id = utils.partner_id_map[self.partner.text()]</span>
        <span class="s1">self.proforma.warehouse_id = utils.warehouse_id_map[self.warehouse.currentText()]</span>
        <span class="s1">self.proforma.courier_id = utils.courier_id_map[self.courier.currentText()]</span>
        <span class="s1">self.proforma.eur_currency = self.eur.isChecked()</span>
        <span class="s1">self.proforma.credit_amount = self.credit.value()</span>
        <span class="s1">self.proforma.credit_days = self.days.value()</span>
        <span class="s1">self.proforma.incoterm = self.incoterms.currentText()</span>
        <span class="s1">self.proforma.external = self.external.text()</span>
        <span class="s1">self.proforma.tracking = self.tracking.text()</span>
        <span class="s1">self.proforma.note = self.note.toPlainText()[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">255</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">clear_filters(self):</span>
        <span class="s1">self.description.clear()</span>
        <span class="s1">self.spec.clear()</span>
        <span class="s1">self.condition.clear()</span>


<span class="s0">class </span><span class="s1">EditableForm(Form):</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">parent</span><span class="s0">, </span><span class="s1">view</span><span class="s0">, </span><span class="s1">proforma):</span>
        <span class="s1">reload_utils()</span>
        <span class="s1">self.proforma = proforma</span>
        <span class="s1">super().__init__(parent</span><span class="s0">, </span><span class="s1">view)</span>
        <span class="s1">self.update_totals()</span>

    <span class="s0">def </span><span class="s1">init_template(self):</span>
        <span class="s1">self.proforma_to_form()</span>
        <span class="s1">self.warehouse.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">self.disable_if_cancelled()</span>

    <span class="s0">def </span><span class="s1">save_template(self):</span>
        <span class="s0">for </span><span class="s1">o </span><span class="s0">in </span><span class="s1">db.session:</span>
            <span class="s0">if </span><span class="s1">type(o) == db.AdvancedLine:</span>
                <span class="s1">print(o)</span>

    <span class="s0">def </span><span class="s1">disable_if_cancelled(self):</span>
        <span class="s0">if </span><span class="s1">self.proforma.cancelled:</span>
            <span class="s1">self.delete_.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.header.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.create_line.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.search.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.insert.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.add.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">self.save.setEnabled(</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">get_form(parent</span><span class="s0">, </span><span class="s1">view</span><span class="s0">, </span><span class="s1">proforma=</span><span class="s0">None</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">EditableForm(parent</span><span class="s0">, </span><span class="s1">view</span><span class="s0">, </span><span class="s1">proforma) </span><span class="s0">if </span><span class="s1">proforma \</span>
        <span class="s0">else </span><span class="s1">Form(parent</span><span class="s0">, </span><span class="s1">view)</span>
</pre>
</body>
</html>